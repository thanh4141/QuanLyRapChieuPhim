<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt vé trực tiếp - Cinema Booking</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        .customer-info-card {
            margin-bottom: var(--spacing-lg);
        }
        .payment-method-select {
            margin-top: var(--spacing-md);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header__container">
            <a href="index.html" class="header__logo">Cinema Booking</a>
            <nav class="header__nav">
                <a href="index.html" class="header__nav-link">Phim</a>
                <a href="staff-booking.html" class="header__nav-link header__nav-link--active">Đặt vé trực tiếp</a>
                <a href="staff-checkin.html" class="header__nav-link">Check-in vé</a>
                <a href="staff-tickets.html" class="header__nav-link">Danh sách vé hôm nay</a>
                <span id="user-menu" class="header__user-menu">
                    <span class="header__user-name" id="user-name"></span>
                    <button class="btn btn--outline btn--small" onclick="handleLogout()">Đăng xuất</button>
                </span>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <h1 class="mb-lg">Đặt vé trực tiếp</h1>

            <div id="alert-container"></div>

            <!-- Showtime Selection Section -->
            <div id="showtime-selection-section" class="card mb-lg">
                <div class="card__header">
                    <h3 class="card__title">Chọn suất chiếu</h3>
                </div>
                <div class="card__body">
                    <div class="form-group">
                        <label for="showtime-date" class="form-label">Ngày chiếu</label>
                        <input type="date" id="showtime-date" class="form-input" value="">
                    </div>
                    <div id="showtimes-list" style="margin-top: var(--spacing-md);">
                        <!-- Showtimes will be loaded here -->
                    </div>
                    <div id="showtimes-loading" class="spinner hidden"></div>
                </div>
            </div>

            <!-- Booking Section (hidden until showtime selected) -->
            <div id="booking-section" style="display: none;">
                <div class="mb-md">
                    <button onclick="goBackToShowtimeSelection()" class="btn btn--outline">
                        ← Quay lại chọn suất chiếu
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl);">
                    <div>
                        <div id="screen" style="text-align: center; padding: var(--spacing-lg); background: linear-gradient(to bottom, var(--bg-secondary), var(--bg-card)); border-radius: var(--border-radius-lg); margin-bottom: var(--spacing-lg);">
                            <p style="font-size: 1.25rem; font-weight: 600;">MÀN HÌNH</p>
                        </div>

                        <div id="seat-grid-container">
                            <!-- Seat grid will be loaded here -->
                        </div>

                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg); flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="width: 24px; height: 24px; background-color: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: var(--border-radius);"></div>
                            <span>Trống</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="width: 24px; height: 24px; background-color: var(--primary-color); border: 2px solid var(--primary-color); border-radius: var(--border-radius);"></div>
                            <span>Đã chọn</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <div style="width: 24px; height: 24px; background-color: var(--bg-primary); border: 2px solid var(--border-color); border-radius: var(--border-radius);"></div>
                            <span>Đã đặt</span>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card customer-info-card">
                        <div class="card__header">
                            <h3 class="card__title">Thông tin khách hàng</h3>
                        </div>
                        <div class="card__body">
                            <div class="form-group">
                                <label for="customer-email" class="form-label">Email khách hàng (tùy chọn)</label>
                                <input type="email" id="customer-email" class="form-input" placeholder="customer@example.com">
                                <small style="color: var(--text-secondary);">Để trống nếu đặt vé cho khách vãng lai</small>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="position: sticky; top: 100px;">
                        <div class="card__header">
                            <h3 class="card__title" id="movie-title">Thông tin đặt vé</h3>
                        </div>
                        <div class="card__body">
                            <p id="showtime-info"></p>
                            <p id="selected-seats" class="mt-md"></p>
                            <p id="total-amount" class="mt-md" style="font-size: 1.25rem; font-weight: 600; color: var(--primary-color);"></p>
                            
                            <div class="form-group payment-method-select">
                                <label for="payment-method" class="form-label">Phương thức thanh toán</label>
                                <select id="payment-method" class="form-input">
                                    <option value="Cash">Tiền mặt</option>
                                    <option value="Card">Thẻ</option>
                                    <option value="BankTransfer">Chuyển khoản</option>
                                </select>
                            </div>
                        </div>
                        <div class="card__footer">
                            <button id="book-button" class="btn btn--primary btn--large" style="width: 100%;" disabled>Đặt vé và thanh toán</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer__container">
            <p>&copy; 2024 Cinema Booking. All rights reserved.</p>
        </div>
    </footer>

    <script src="../js/apiClient.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/showtimes.js"></script>
    <script>
        // Check authentication and staff role
        if (!isAuthenticated()) {
            window.location.href = 'login.html';
        }

        const user = getCurrentUser();
        if (!user.roles || (!user.roles.includes('Staff') && !user.roles.includes('Admin'))) {
            // Use inline alert since showAlert might not be loaded yet
            document.getElementById('alert-container').innerHTML = '<div class="alert alert--error">Bạn không có quyền truy cập trang này</div>';
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        initUserMenu();
        const userNameEl = document.getElementById('user-name');
        if (userNameEl) {
            userNameEl.textContent = user.fullName || user.username;
        }

        async function handleLogout() {
            await logout();
        }

        // Helper function to show alert (fallback if booking.js not loaded)
        function showAlertHelper(message, type) {
            const container = document.getElementById('alert-container');
            if (container) {
                container.innerHTML = `<div class="alert alert--${type}">${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            } else {
                alert(message);
            }
        }

        let selectedShowtimeId = null;

        // Load showtimes on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('showtime-date');
            if (dateInput) {
                dateInput.value = today;
            }

            // Load showtimes for today
            await loadShowtimesForDate(today);

            // Listen for date change
            if (dateInput) {
                dateInput.addEventListener('change', async (e) => {
                    await loadShowtimesForDate(e.target.value);
                });
            }

            // Check if showtimeId is in URL (from external link)
            const urlParams = new URLSearchParams(window.location.search);
            const showtimeId = urlParams.get('showtimeId');
            if (showtimeId) {
                await selectShowtime(parseInt(showtimeId));
            }
        });

        // Load showtimes for a specific date
        async function loadShowtimesForDate(date) {
            const container = document.getElementById('showtimes-list');
            const loading = document.getElementById('showtimes-loading');
            
            if (!container || !loading) return;

            container.innerHTML = '';
            loading.classList.remove('hidden');

            try {
                const params = new URLSearchParams({
                    pageIndex: 1,
                    pageSize: 100,
                    date: date
                });

                const response = await get(`/showtimes?${params.toString()}`);

                if (response.success && response.data) {
                    const showtimes = response.data.items || response.data;
                    
                    if (showtimes.length === 0) {
                        container.innerHTML = '<p class="text-center">Không có suất chiếu nào cho ngày này.</p>';
                    } else {
                        // Group by movie
                        const showtimesByMovie = {};
                        showtimes.forEach(st => {
                            const movieTitle = st.movieTitle || 'N/A';
                            if (!showtimesByMovie[movieTitle]) {
                                showtimesByMovie[movieTitle] = [];
                            }
                            showtimesByMovie[movieTitle].push(st);
                        });

                        // Render grouped showtimes
                        Object.keys(showtimesByMovie).forEach(movieTitle => {
                            const movieDiv = document.createElement('div');
                            movieDiv.className = 'card mb-md';
                            movieDiv.innerHTML = `<div class="card__header"><h4 style="margin: 0;">${movieTitle}</h4></div>`;
                            
                            const bodyDiv = document.createElement('div');
                            bodyDiv.className = 'card__body';
                            bodyDiv.style.display = 'flex';
                            bodyDiv.style.gap = 'var(--spacing-sm)';
                            bodyDiv.style.flexWrap = 'wrap';

                            showtimesByMovie[movieTitle].forEach(showtime => {
                                const startTime = new Date(showtime.startTime);
                                const isPast = startTime <= new Date();
                                
                                const btn = document.createElement('button');
                                btn.className = `btn ${isPast ? 'btn--secondary' : 'btn--primary'}`;
                                btn.style.minWidth = '120px';
                                btn.disabled = isPast;
                                btn.innerHTML = `
                                    <div style="text-align: center;">
                                        <div style="font-weight: 600;">${startTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                                        <div style="font-size: 0.75rem; margin-top: var(--spacing-xs);">${showtime.auditoriumName || 'N/A'}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${showtime.baseTicketPrice?.toLocaleString('vi-VN') || '0'} đ</div>
                                    </div>
                                `;
                                
                                if (!isPast) {
                                    btn.onclick = () => selectShowtime(showtime.showtimeId);
                                } else {
                                    btn.title = 'Suất chiếu đã bắt đầu';
                                }
                                
                                bodyDiv.appendChild(btn);
                            });

                            movieDiv.appendChild(bodyDiv);
                            container.appendChild(movieDiv);
                        });
                    }
                } else {
                    container.innerHTML = '<p class="alert alert--error">Lỗi khi tải danh sách suất chiếu.</p>';
                }
            } catch (error) {
                console.error('Load showtimes error:', error);
                container.innerHTML = '<p class="alert alert--error">Lỗi khi tải danh sách suất chiếu.</p>';
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Select a showtime and load booking page
        async function selectShowtime(showtimeId) {
            selectedShowtimeId = showtimeId;
            
            // Hide showtime selection, show booking section
            const selectionSection = document.getElementById('showtime-selection-section');
            const bookingSection = document.getElementById('booking-section');
            
            if (selectionSection) {
                selectionSection.style.display = 'none';
            }
            if (bookingSection) {
                bookingSection.style.display = 'block';
            }

            // Wait for booking.js to load
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                if (typeof loadBookingPage === 'function') {
                    await loadBookingPage(showtimeId);
                } else {
                    showAlertHelper('Lỗi: Không thể tải trang đặt vé. Vui lòng tải lại trang.', 'error');
                }
            } catch (error) {
                console.error('Load booking page error:', error);
                showAlertHelper('Lỗi khi tải trang đặt vé: ' + error.message, 'error');
            }
        }

        // Go back to showtime selection
        function goBackToShowtimeSelection() {
            selectedShowtimeId = null;
            
            const selectionSection = document.getElementById('showtime-selection-section');
            const bookingSection = document.getElementById('booking-section');
            
            if (selectionSection) {
                selectionSection.style.display = 'block';
            }
            if (bookingSection) {
                bookingSection.style.display = 'none';
            }

            // Reset booking state
            if (typeof selectedSeatIds !== 'undefined') {
                selectedSeatIds = [];
            }
            if (typeof currentShowtime !== 'undefined') {
                currentShowtime = null;
            }
            if (typeof currentSeats !== 'undefined') {
                currentSeats = [];
            }
        }

        // Override book button click for direct booking
        // Wait for booking.js to load first, then override
        setTimeout(() => {
            const bookButton = document.getElementById('book-button');
            if (bookButton) {
                // Remove existing event listener by replacing the button
                const newButton = bookButton.cloneNode(true);
                bookButton.parentNode.replaceChild(newButton, bookButton);
                
                newButton.addEventListener('click', async () => {
                    // Use showAlert if available, otherwise use helper
                    const alertFn = typeof showAlert === 'function' ? showAlert : showAlertHelper;
                    
                    if (typeof selectedSeatIds === 'undefined' || selectedSeatIds.length === 0) {
                        alertFn('Vui lòng chọn ít nhất một ghế', 'error');
                        return;
                    }

                    if (typeof currentShowtime === 'undefined' || !currentShowtime) {
                        alertFn('Thông tin suất chiếu không hợp lệ', 'error');
                        return;
                    }

                    // Show confirmation modal
                    const customerEmail = document.getElementById('customer-email').value.trim();
                    const paymentMethod = document.getElementById('payment-method').value;
                    
                    // Calculate total
                    let totalAmount = 0;
                    if (bookingPreview && bookingPreview.totalAmount) {
                        totalAmount = bookingPreview.totalAmount;
                    } else if (typeof currentSeats !== 'undefined') {
                        const selectedSeats = currentSeats.filter(s => selectedSeatIds.includes(s.seatId));
                        selectedSeats.forEach(seat => {
                            // Estimate price (will be calculated on server)
                            totalAmount += currentShowtime.baseTicketPrice || 0;
                        });
                        totalAmount = totalAmount * 1.1; // Add tax
                    }

                    const confirmMessage = `Xác nhận thanh toán:\n\n` +
                        `Phim: ${currentShowtime.movieTitle || 'N/A'}\n` +
                        `Phòng: ${currentShowtime.auditoriumName || 'N/A'}\n` +
                        `Ghế: ${selectedSeatIds.length} ghế\n` +
                        `Tổng tiền: ${totalAmount.toLocaleString('vi-VN')} đ\n` +
                        `Phương thức: ${paymentMethod === 'Cash' ? 'Tiền mặt' : paymentMethod === 'Card' ? 'Thẻ' : 'Chuyển khoản'}\n` +
                        (customerEmail ? `Khách hàng: ${customerEmail}\n` : '') +
                        `\nBạn có chắc chắn muốn thanh toán và in vé?`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    const button = document.getElementById('book-button');
                    button.disabled = true;
                    button.textContent = 'Đang xử lý...';

                    try {
                        const request = {
                            showtimeId: selectedShowtimeId || currentShowtime?.showtimeId,
                            seatIds: selectedSeatIds,
                            paymentMethod: paymentMethod,
                            customerEmail: customerEmail || null
                        };

                        const response = await post('/bookings/staff/direct', request, true);

                        if (response.success && response.data) {
                            alertFn('Đặt vé trực tiếp thành công! Vé đã được thanh toán.', 'success');
                            // Redirect to print page
                            setTimeout(() => {
                                window.location.href = `staff-ticket-print.html?reservationId=${response.data.reservationId}`;
                            }, 1500);
                        } else {
                            alertFn(response.message || 'Lỗi khi đặt vé', 'error');
                            button.disabled = false;
                            button.textContent = 'Đặt vé và thanh toán';
                        }
                    } catch (error) {
                        console.error('Direct booking error:', error);
                        let errorMessage = error.message || 'Lỗi khi đặt vé trực tiếp';
                        
                        // Check if it's an authentication error
                        if (errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {
                            errorMessage = 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                        } else if (errorMessage.includes('403') || errorMessage.includes('Forbidden')) {
                            errorMessage = 'Bạn không có quyền thực hiện thao tác này. Vui lòng đăng nhập với tài khoản Staff hoặc Admin.';
                        }
                        
                        alertFn(errorMessage, 'error');
                        button.disabled = false;
                        button.textContent = 'Đặt vé và thanh toán';
                    }
                });
            }
        }, 500);
    </script>
</body>
</html>

